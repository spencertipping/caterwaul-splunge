<!doctype html>
<html>
<head>
  <script src='jquery.js'></script>
  <script src='caterwaul.js'></script>
  <script src='caterwaul.std.js'></script>
  <script src='caterwaul.ui.js'></script>
  <script src='../splunge.js'></script>
  <script>
    $(caterwaul(':all')(function () {
      $('#splunge-test')
      .mousedown(given.e in v.animate((find(ex / 300 - 1, ey / 300 - 1) || data).self_bbox, 3000)
                            -where [ex = e.pageX - $('#splunge-test').position().left,
                                    ey = e.pageY - $('#splunge-test').position().top])

      .mousemove(given.e in selected /eq.h -then- render(data, v.transform())
                            -where [ex = e.pageX - $('#splunge-test').position().left,
                                    ey = e.pageY - $('#splunge-test').position().top,
                                    h  = find(ex / 300 - 1, ey / 300 - 1)]),

      render(data, v.transform()),
      $('#status').text('#{children} data elements'),
      where [random_children(n) = caterwaul.splunge.normalized(n[n - Math.random() * 2] *[child(n * 0.6)] -seq),
             children           = 0,
             random_color()     = 'rgba(0, 20, 40, #{Math.random() * 0.5 + 0.2})',
             child(n)           = ++children -then- {dy:    Math.random() / n,
                                                     dx:    Math.random(),
                                                     color: random_color(),
                                                     xs:    random_children(n)},
             data               = {name: 'root', y0: 0, dy: 1, xs: random_children(15)},
             selected           = null,

             v                  = viewport({x0: 3, dx: 2, y0: 0, dy: 1}, "render(data, _)".qf),

             duration           = 800,
             spline(x)          = Math.cos(Math.PI * x) * -0.5 + 0.5,

             c                  = caterwaul,
             find(x, y)         = c.splunge.find_by_transformed(data, v.transform(), {x: x, y: y}),

             render(data, t)    = $('#splunge-test')[0].getContext('2d')
                                  <se> it.fillStyle /eq['white'] -then-
                                       it.fillRect(0, 0, 800, 600) -then-
                                       it.save() -then-
                                       it.scale(300, 300) -then-
                                       it.translate(1, 1) -then-
                                       it.lineWidth /eq[0.005] -then-
                                       c.splunge.paths(data, t)(given [p, h, t] in
                                         it.beginPath() -then-
                                         p(it) -then-
                                         it.fillStyle /eq[h === selected ? 'red' : h.color] -then-
                                         it.strokeStyle /eq['white'] -then-
                                         it.fill() -then-
                                         it.stroke() -then- true
                                         -when [delta.d > 0.1 && delta.angle > tau * 0.004]
                                         -where [delta = dt(t, bbox(h) /!base, bbox(h) /-project/ 1)]) -then-
                                       it.restore()],
      using [caterwaul.splunge]}));
  </script>
</head>
<body>
  <canvas id='splunge-test' width='800' height='600'></canvas>
</body>
</html>
