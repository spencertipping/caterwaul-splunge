<!doctype html>
<html>
<head>
  <script src='jquery.js'></script>
  <script src='caterwaul.js'></script>
  <script src='caterwaul.std.js'></script>
  <script src='caterwaul.ui.js'></script>
  <script src='../splunge.js'></script>
  <script>
    $(caterwaul(':all')(function () {
      $('#splunge-test')
      .mousedown(given.e in tween_to((find(ex / 200 - 1, ey / 200 - 1) || data).self_bbox)
                            -where [ex = e.pageX - $('#splunge-test').position().left,
                                    ey = e.pageY - $('#splunge-test').position().top])

      .mousemove(given.e in selected /eq.h -then- render(data, current_transform)
                            -where [ex = e.pageX - $('#splunge-test').position().left,
                                    ey = e.pageY - $('#splunge-test').position().top,
                                    h  = find(ex / 200 - 1, ey / 200 - 1)]),

      render(data, current_transform),
      $('#status').text('#{children} data elements'),
      where [random_children(n) = caterwaul.splunge.normalized(n[n - Math.random() * 2] *[child(n * 0.6)] -seq),
             children           = 0,
             random_color()     = 'rgba(0, 20, 40, #{Math.random() * 0.5 + 0.2})',
             child(n)           = ++children -then- {dy:    Math.random() / n,
                                                     dx:    Math.random(),
                                                     color: random_color(),
                                                     xs:    random_children(n)},
             data               = {name: 'root', y0: 0, dy: 1, xs: random_children(15)},
             selected           = null,
             current_transform  = {x0: 0, dx: 1, y0: 0, dy: 1},

             tween_interval     = null,
             tween_to(p)        = clearInterval(tween_interval) /when.tween_interval -then-
                                  tween_interval /eq [setInterval(interpolate(current_transform, p, +new Date), 30)],

             duration           = 800,
             spline(x)          = Math.cos(Math.PI * x) * -0.5 + 0.5,
             interpolate(p1, p2, start)() = render(data, current_transform = c.splunge.interpolate(p1, p2, x))
                                            -then- (render(data, current_transform = p2),
                                                    clearInterval(tween_interval)) /when [now > start + duration]
                                            -where [now = +new Date,
                                                    x   = Math.min(1, spline((now - start) / duration))],

             c                  = caterwaul,
             find(x, y)         = c.splunge.find_by_transformed(data, current_transform, {x: x, y: y}),

             render(data, t)    = $('#splunge-test')[0].getContext('2d')
                                  <se> it.fillStyle /eq['white'] -then-
                                       it.fillRect(0, 0, 800, 400) -then-
                                       it.save() -then-
                                       it.scale(200, 200) -then-
                                       it.translate(1, 1) -then-
                                       it.lineWidth /eq[0.005] -then-
                                       c.splunge.paths(data, t)(given [p, h, t] in
                                         it.beginPath() -then-
                                         p(it) -then-
                                         it.fillStyle /eq[h === selected ? 'red' : h.color] -then-
                                         it.strokeStyle /eq['white'] -then-
                                         it.fill() -then-
                                         it.stroke() -then- true
                                         -when [delta.d > 0.01 && delta.angle > tau * 0.001]
                                         -where [delta = dt(t, self_bbox(h) /!base, self_bbox(h) /-project/ 1)]) -then-
                                       it.restore()],
      using [caterwaul.splunge]}));
  </script>
</head>
<body>
  <div id='status'></div>
  <canvas id='splunge-test' width='800' height='400'></canvas>
</body>
</html>
